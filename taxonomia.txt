<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo de Clasificación de Taxonomías</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0c111d; }
        .form-label { color: #9ca3af; font-size: 0.875rem; margin-bottom: 0.5rem; display: block; }
        .form-input, .form-select, .form-textarea { background-color: #1f2937; border: 1px solid #374151; color: #f9fafb; border-radius: 0.375rem; width: 100%; padding: 0.75rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #6b7280; }
    </style>
</head>
<body class="text-gray-200 p-8">

    <div id="view-clasificacion" class="content-view active">
         <h2 class="text-2xl font-bold mb-6 text-white">4. Clasificación de Taxonomías</h2>
         <div class="bg-gray-800/50 p-5 rounded-lg border border-gray-700 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                <div class="flex-grow">
                    <label for="taxonomia-select" class="form-label">Seleccione una taxonomía para gestionar</label>
                    <select id="taxonomia-select" class="form-select"></select>
                </div>
            </div>
        </div>
        <div id="taxonomy-workspace" class="bg-gray-800/50 p-5 rounded-lg border border-gray-700">
            <!-- El workspace de la taxonomía seleccionada se cargará aquí -->
        </div>
    </div>

    <!-- Plantillas Ocultas -->
    <template id="taxonomy-workspace-template">
        <div>
            <h3 class="text-lg font-semibold text-white mb-4 title-text"></h3>
            <textarea class="form-textarea comment-box" rows="4" placeholder="Escriba aquí un comentario general para esta taxonomía..."></textarea>
            <div class="mt-6">
                <button class="btn btn-secondary btn-sm" onclick="addFileToTaxonomy(this)">
                    <i class="fa-solid fa-plus mr-2"></i>Agregar Evidencia a esta Taxonomía
                </button>
                <input type="file" class="hidden" onchange="handleTaxonomyFileSelect(this)">
            </div>
            <div class="mt-6 overflow-x-auto">
                <table class="min-w-full text-sm text-left">
                    <thead class="bg-gray-700/50">
                        <tr>
                            <th scope="col" class="px-4 py-3 font-medium">Nombre archivo</th>
                            <th scope="col" class="px-4 py-3 font-medium">Comentario del archivo</th>
                            <th scope="col" class="px-4 py-3 font-medium">Fecha y hora subida</th>
                            <th scope="col" class="px-4 py-3 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="evidence-table-body"></tbody>
                </table>
            </div>
        </div>
    </template>
    
<script>
// --- SIMULACIÓN DE DATOS ---
const allTaxonomies = [
    { id: "INC_USO_PHIP_ECDP", title: "Envío de correo no deseado o phishing desde infraestructura propia", category: "Actividades de phishing o fraude en infraestructura propia" },
    { id: "INC_USO_PHIP_ISFI", title: "Inclusión de sitio fraudulento en infraestructura propia", category: "Actividades de phishing o fraude en infraestructura propia" },
    { id: "INC_USO_PHRI_ECSO", title: "Envío de correo no deseado o phishing sobre una organización", category: "Actividades de phishing o fraude relacionadas con la institución" },
    { id: "INC_USO_PHRI_ECUR", title: "Envío de correo no deseado o phishing usando remitentes de la institución", category: "Actividades de phishing o fraude relacionadas con la institución" },
    { id: "INC_USO_EJNA_ERCA", title: "Ejecución remota de código a través de parámetros de aplicación", category: "Ejecución no autorizada de código" },
    { id: "INC_USO_EJNA_ICNQ", title: "Inyección de consultas NoSQL", category: "Ejecución no autorizada de código" },
    { id: "INC_USO_EJNA_ICSL", title: "Inyección de consultas SQL", category: "Ejecución no autorizada de código" },
    { id: "INC_USO_EJNA_IRLL", title: "Inyección de requerimientos (prompts) en modelos grandes de lenguaje (LLM)", category: "Ejecución no autorizada de código" },
    { id: "INC_USO_UNRI_ACNA", title: "Acceso no autorizado a almacenamiento", category: "Uso no autorizado de redes y sistemas informáticos" },
    { id: "INC_USO_UNRI_AFBE", title: "Ataque de fuerza bruta exitoso", category: "Uso no autorizado de redes y sistemas informáticos" },
    { id: "INC_USO_UNRI_EXVA", title: "Explotación de vulnerabilidades de autenticación", category: "Uso no autorizado de redes y sistemas informáticos" },
    { id: "INC_USO_UNRI_USCC", title: "Uso de credenciales comprometidas", category: "Uso no autorizado de redes y sistemas informáticos" },
    { id: "INC_CONF_EXCS_ACVE", title: "Archivo(s) de control de versión expuestos en aplicación", category: "Exfiltración y/o exposición de código fuente" },
    { id: "INC_CONF_EXCS_SCVE", title: "Sistema de control de versión expuesto", category: "Exfiltración y/o exposición de código fuente" },
    { id: "INC_CONF_EXCF_FCRA", title: "Filtración de configuraciones en rutas de aplicación", category: "Exfiltración y/o exposición de configuraciones" },
    { id: "INC_CONF_EXCF_FSRA", title: "Filtración de secretos en rutas de aplicación", category: "Exfiltración y/o exposición de configuraciones" },
    { id: "INC_CONF_EXDA_ADVM", title: "Adversario en el medio (MitM)", category: "Exfiltración y/o exposición de datos" },
    { id: "INC_CONF_EXDA_ACMP", title: "Apropiación de credenciales mediante phishing", category: "Exfiltración y/o exposición de datos" },
    { id: "INC_CONF_EXDA_DPDS", title: "Documentos públicos con datos sensibles", category: "Exfiltración y/o exposición de datos" },
    { id: "INC_CONF_EXDA_FDP", title: "Filtración de datos personales", category: "Exfiltración y/o exposición de datos" },
    { id: "INC_CONF_EXDA_KEYL", title: "Keylogger en uso", category: "Exfiltración y/o exposición de datos" },
    { id: "INC_DISP_DEGS_SDRC", title: "Secuestro de recursos (cryptojacking)", category: "Degradación de servicio" },
    { id: "INC_DISP_DEGS_SOBD", title: "Sobrecarga de bases de datos", category: "Degradación de servicio" },
    { id: "INC_DISP_DEGS_UEAB", title: "Uso excesivo de ancho de banda", category: "Degradación de servicio" },
    { id: "INC_DISP_INDS_ACT", title: "Agotamiento de conexiones TCP", category: "Indisponibilidad y/o denegación de servicio" },
    { id: "INC_DISP_INDS_ANSI", title: "Apagado no autorizado de sistemas informáticos", category: "Indisponibilidad y/o denegación de servicio" },
    { id: "INC_DISP_INDS_AADN", title: "Ataque de amplificación DNS/NTP", category: "Indisponibilidad y/o denegación de servicio" },
    { id: "INC_DISP_INDS_DSEV", title: "Denegación de servicio a través de la explotación de vulnerabilidades", category: "Indisponibilidad y/o denegación de servicio" },
    { id: "INC_DISP_INDS_ELCC", title: "Eliminación de configuraciones críticas", category: "Indisponibilidad y/o denegación de servicio" },
    { id: "INC_INTG_MNAC_ALRF", title: "Alteración de reglas de firewall", category: "Manipulación no autorizada de configuración" },
    { id: "INC_INTG_MNAC_DRDS", title: "Desactivación de registros de seguridad", category: "Manipulación no autorizada de configuración" },
    { id: "INC_INTG_MNAC_MPDA", title: "Modificación de políticas de acceso", category: "Manipulación no autorizada de configuración" },
    { id: "INC_INTG_MNDA_ALBD", title: "Alteración de bases de datos", category: "Modificación no autorizada de datos" },
    { id: "INC_INTG_MNDA_ALSW", title: "Alteración de sitio web (defacement)", category: "Modificación no autorizada de datos" },
    { id: "INC_INTG_MNDA_MDNA", title: "Manipulación de datos no autentificados", category: "Modificación no autorizada de datos" },
    { id: "INC_PSE_PAGO_FRAUD", title: "Transacciones fraudulentas", category: "Fraude en transacciones" },
    { id: "INC_PSE_PAGO_LAVAN", title: "Uso del sistema para lavado de activos", category: "Lavado de dinero" },
    { id: "INC_PSE_PAGO_SKIMM", title: "Clonación de tarjetas de pago", category: "Skimming de tarjetas" }
];

let dataStore = {
    "INC_USO_UNRI_AFBE": { comment: "Comentario general sobre fuerza bruta.", files: [] },
    "INC_CONF_EXDA_FDP": { comment: "", files: [{ id: `ev-tax-1`, name: "leaked_data_sample.csv", description: "Muestra de los datos filtrados.", timestamp: "10-07-2025 15:01:10" }] }
};

// --- LÓGICA DE CLASIFICACIÓN DE TAXONOMÍAS ---
function initializeTaxonomyWorkspace() {
    const select = document.getElementById('taxonomia-select');
    select.innerHTML = '';
    allTaxonomies.forEach(tax => {
        const option = document.createElement('option');
        option.value = tax.id;
        option.textContent = tax.title;
        select.appendChild(option);
    });
    select.onchange = displaySelectedTaxonomy;
    displaySelectedTaxonomy();
}

function displaySelectedTaxonomy() {
    const select = document.getElementById('taxonomia-select');
    const taxonomyId = select.value;
    const tax = allTaxonomies.find(t => t.id === taxonomyId);
    if (!dataStore[taxonomyId]) {
        dataStore[taxonomyId] = { comment: '', files: [] };
    }
    const data = dataStore[taxonomyId];
    
    const workspace = document.getElementById('taxonomy-workspace');
    const template = document.getElementById('taxonomy-workspace-template');
    workspace.innerHTML = '';
    const clone = template.content.cloneNode(true);

    clone.querySelector('.title-text').textContent = tax.title;
    clone.querySelector('.comment-box').value = data.comment;
    clone.querySelector('.comment-box').onchange = (e) => { data.comment = e.target.value; };

    workspace.appendChild(clone);
    renderTaxonomyEvidenceTable(taxonomyId);
}

function renderTaxonomyEvidenceTable(taxonomyId) {
    const tableBody = document.querySelector('#taxonomy-workspace .evidence-table-body');
    tableBody.innerHTML = '';
    const files = dataStore[taxonomyId].files;

    if (files.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">No hay evidencias para esta taxonomía.</td></tr>`;
        return;
    }

    files.forEach((file, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700';
        row.innerHTML = `
            <td class="px-4 py-3 font-medium">${file.name}</td>
            <td class="px-4 py-3">
                <input type="text" class="form-input text-xs" placeholder="Añadir comentario..." value="${file.description}" onchange="updateTaxonomyFileDescription('${taxonomyId}', ${index}, this.value)">
            </td>
            <td class="px-4 py-3 text-gray-400">${file.timestamp}</td>
            <td class="px-4 py-3 text-right flex items-center justify-end gap-2">
                 <button class="text-green-500 hover:text-green-400" onclick="updateTaxonomyFileDescription('${taxonomyId}', ${index}, this.parentElement.previousElementSibling.previousElementSibling.querySelector('input').value, true)" title="Guardar Comentario">
                    <i class="fa-solid fa-save"></i>
                </button>
                <button class="text-blue-500 hover:text-blue-400" onclick="viewEvidence('${file.id}')" title="Visualizar Archivo"><i class="fa-solid fa-eye"></i></button>
                <button class="text-red-500 hover:text-red-400" onclick="deleteTaxonomyFile('${taxonomyId}', ${index})"><i class="fa-solid fa-trash-can"></i></button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function addFileToTaxonomy(button) {
    button.nextElementSibling.click();
}

function handleTaxonomyFileSelect(fileInput) {
    const taxonomyId = document.getElementById('taxonomia-select').value;
    const now = new Date();
    const formattedDateTime = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    for (const file of fileInput.files) {
        dataStore[taxonomyId].files.push({
            id: `ev-tax-${Date.now()}-${Math.random()}`,
            name: file.name,
            description: "",
            timestamp: formattedDateTime
        });
    }
    renderTaxonomyEvidenceTable(taxonomyId);
    fileInput.value = '';
}

function updateTaxonomyFileDescription(taxonomyId, index, description, showAlert = false) {
    dataStore[taxonomyId].files[index].description = description;
    if (showAlert) alert('Comentario guardado.');
}

function deleteTaxonomyFile(taxonomyId, index) {
    dataStore[taxonomyId].files.splice(index, 1);
    renderTaxonomyEvidenceTable(taxonomyId);
}

function viewEvidence(evidenceId) {
    alert(`Simulando la visualización de la evidencia con ID: ${evidenceId}`);
}

// Carga inicial
document.addEventListener('DOMContentLoaded', () => {
    initializeTaxonomyWorkspace();
});
</script>
</body>
</html>