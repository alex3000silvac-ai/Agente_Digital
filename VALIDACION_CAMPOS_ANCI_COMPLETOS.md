# üîç VALIDACI√ìN COMPLETA DE CAMPOS ANCI - AN√ÅLISIS Y CORRECCIONES

## üìã **CAMPOS ENCONTRADOS EN ReportesANCI vs IMPLEMENTACI√ìN**

### ‚úÖ **CAMPOS IMPLEMENTADOS CORRECTAMENTE**

#### **Secci√≥n 1: Identificaci√≥n General**
- ‚úÖ `titulo` ‚Üí `Titulo` (tabla Incidentes)
- ‚úÖ `tipoFlujo` ‚Üí `TipoFlujo` (tabla Incidentes)
- ‚úÖ `fechaDeteccion` ‚Üí `FechaDeteccion` (tabla Incidentes)
- ‚úÖ `fechaOcurrencia` ‚Üí `FechaOcurrencia` (tabla Incidentes)
- ‚úÖ `criticidad` ‚Üí `Criticidad` (tabla Incidentes)
- ‚úÖ `alcanceGeografico` ‚Üí `AlcanceGeografico` (tabla Incidentes)
- ‚úÖ `estadoActual` ‚Üí `EstadoActual` (tabla Incidentes)

#### **Secci√≥n 2: Descripci√≥n y Alcance**
- ‚úÖ `descripcionInicial` ‚Üí `DescripcionInicial` (tabla Incidentes)
- ‚úÖ `sistemasAfectados` ‚Üí `SistemasAfectados` (tabla Incidentes)
- ‚úÖ `serviciosInterrumpidos` ‚Üí `ServiciosInterrumpidos` (tabla Incidentes)

#### **Secci√≥n 3: An√°lisis Preliminar**
- ‚úÖ `tipoAmenaza` ‚Üí `AnciTipoAmenaza` (tabla Incidentes)
- ‚úÖ `origenIncidente` ‚Üí `OrigenIncidente` (tabla Incidentes)
- ‚úÖ `responsableCliente` ‚Üí `ResponsableCliente` (tabla Incidentes)

#### **Secci√≥n 5: Acciones Inmediatas**
- ‚úÖ `accionesInmediatas` ‚Üí `AccionesInmediatas` (tabla Incidentes)

#### **Secci√≥n 6: An√°lisis de Causa Ra√≠z**
- ‚úÖ `causaRaiz` ‚Üí `CausaRaiz` (tabla Incidentes)
- ‚úÖ `leccionesAprendidas` ‚Üí `LeccionesAprendidas` (tabla Incidentes)
- ‚úÖ `planMejora` ‚Üí `PlanMejora` (tabla Incidentes)

### ‚ùå **CAMPOS FALTANTES CR√çTICOS**

#### **Campos de Reportante (ReportesANCI)**
- ‚ùå `AnciNombreReportante` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciCargoReportante` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciCorreoReportante` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciTelefonoReportante` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciFormacionCertificacion` - **FALTA IMPLEMENTAR**

#### **Campos de An√°lisis Avanzado (ReportesANCI)**
- ‚ùå `AnciFechaAlertaTemprana` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciImpactoPreliminar` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciEvolucionIncidente` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciMedidasContencion` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciPlanAccion` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciResumenEjecutivo` - **FALTA IMPLEMENTAR**

#### **Campos de Indicadores de Compromiso (ReportesANCI)**
- ‚ùå `AnciIoCIPs` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciIoCDominios` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciIoCHashes` - **FALTA IMPLEMENTAR**

#### **Campos de Impacto Detallado (ReportesANCI)**
- ‚ùå `AnciSistemasAfectadosDetalle` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciImpactoContinuidadDatos` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciAfectacionTerceros` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciNumeroAfectados` - **FALTA IMPLEMENTAR**

#### **Campos de Acciones y Notificaciones (ReportesANCI)**
- ‚ùå `AnciAccionesContencion` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciSistemasDesconectados` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciNotificacionesInternas` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciEstadoActualIncidente` - **FALTA IMPLEMENTAR**

#### **Campos Espec√≠ficos OIV (ReportesANCI)**
- ‚ùå `AnciOIVCuentaConSGSI` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciOIVDetallePlanContinuidad` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciOIVActivoPlanRecuperacion` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciOIVAuditoriasRealizadas` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciOIVFechaUltimaAuditoria` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciOIVDelegadoTecnico` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciOIVMedidasPropagacion` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciOIVNotificacionAfectados` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciOIVRegistroCapacitaciones` - **FALTA IMPLEMENTAR**

#### **Campos de Contacto de Seguimiento (ReportesANCI)**
- ‚ùå `AnciContactoSeguimientoNombre` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciContactoSeguimientoHorario` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciContactoSeguimientoCorreo` - **FALTA IMPLEMENTAR**
- ‚ùå `AnciContactoSeguimientoTelefono` - **FALTA IMPLEMENTAR**

#### **Campos de Taxonom√≠a y Clasificaci√≥n**
- ‚ùå `AnciTipoIncidenteTaxonomia` - **FALTA IMPLEMENTAR**

### ‚úÖ **SECCI√ìN CSIRT - IMPLEMENTADA**
- ‚úÖ `solicitarAyudaCSIRT` - **IMPLEMENTADA**
- ‚úÖ `fechaSolicitudCSIRT` - **IMPLEMENTADA**
- ‚úÖ `tipoAyudaCSIRT` - **IMPLEMENTADA**
- ‚úÖ `descripcionAyudaCSIRT` - **IMPLEMENTADA**
- ‚úÖ `urgenciaCSIRT` - **IMPLEMENTADA**
- ‚úÖ `contactoCSIRT` - **IMPLEMENTADA**
- ‚úÖ `estadoSolicitudCSIRT` - **IMPLEMENTADA**
- ‚úÖ `respuestaCSIRT` - **IMPLEMENTADA**
- ‚úÖ `numeroTicketCSIRT` - **IMPLEMENTADA**

## üîß **PROPUESTA DE CORRECCI√ìN COMPLETA**

### **1. Actualizar ANCI_FORMULARIO_CONFIG con Campos Faltantes**

```sql
-- Actualizar Secci√≥n 1 - Agregar campos de reportante
UPDATE ANCI_FORMULARIO_CONFIG
SET CamposJSON = '{
  "campos": [
    {"nombre": "titulo", "tipo": "text", "etiqueta": "T√≠tulo del Incidente", "requerido": true},
    {"nombre": "tipoFlujo", "tipo": "select", "etiqueta": "Tipo de Registro", "opciones": ["Informativo", "Interno"], "requerido": true},
    {"nombre": "fechaDeteccion", "tipo": "datetime-local", "etiqueta": "Fecha y Hora de Detecci√≥n", "requerido": true},
    {"nombre": "fechaOcurrencia", "tipo": "datetime-local", "etiqueta": "Fecha y Hora de Ocurrencia", "requerido": false},
    {"nombre": "criticidad", "tipo": "select", "etiqueta": "Criticidad", "opciones": ["Baja", "Media", "Alta", "Cr√≠tica"], "requerido": true},
    {"nombre": "alcanceGeografico", "tipo": "select", "etiqueta": "Alcance Geogr√°fico", "opciones": ["Local", "Regional", "Nacional", "Internacional"], "requerido": false},
    {"nombre": "fechaAlertaTemprana", "tipo": "datetime-local", "etiqueta": "Fecha Alerta Temprana ANCI", "requerido": false},
    {"nombre": "nombreReportante", "tipo": "text", "etiqueta": "Nombre del Reportante", "requerido": true},
    {"nombre": "cargoReportante", "tipo": "text", "etiqueta": "Cargo del Reportante", "requerido": true},
    {"nombre": "correoReportante", "tipo": "email", "etiqueta": "Correo del Reportante", "requerido": true},
    {"nombre": "telefonoReportante", "tipo": "tel", "etiqueta": "Tel√©fono del Reportante", "requerido": true},
    {"nombre": "formacionCertificacion", "tipo": "textarea", "etiqueta": "Formaci√≥n y Certificaciones en Ciberseguridad", "requerido": false}
  ]
}'
WHERE CodigoSeccion = 'SEC_1';

-- Actualizar Secci√≥n 2 - Agregar campos de impacto detallado
UPDATE ANCI_FORMULARIO_CONFIG
SET CamposJSON = '{
  "campos": [
    {"nombre": "descripcionInicial", "tipo": "textarea", "etiqueta": "Descripci√≥n Inicial Detallada", "requerido": true, "filas": 4},
    {"nombre": "impactoPreliminar", "tipo": "textarea", "etiqueta": "Impacto Preliminar Observado", "requerido": true, "filas": 4},
    {"nombre": "sistemasAfectados", "tipo": "textarea", "etiqueta": "Sistemas, Activos o Personal Afectado", "requerido": true, "filas": 4},
    {"nombre": "serviciosInterrumpidos", "tipo": "textarea", "etiqueta": "Servicios Interrumpidos y Duraci√≥n", "requerido": false, "filas": 3},
    {"nombre": "sistemasAfectadosDetalle", "tipo": "textarea", "etiqueta": "Detalle Espec√≠fico de Sistemas Afectados", "requerido": false, "filas": 4},
    {"nombre": "impactoContinuidadDatos", "tipo": "textarea", "etiqueta": "Impacto en Continuidad de Datos", "requerido": false, "filas": 3},
    {"nombre": "afectacionTerceros", "tipo": "checkbox", "etiqueta": "¬øHubo afectaci√≥n a terceros?", "requerido": false},
    {"nombre": "numeroAfectados", "tipo": "number", "etiqueta": "N√∫mero de Personas Afectadas", "requerido": false, "min": 0},
    {"nombre": "resumenEjecutivo", "tipo": "textarea", "etiqueta": "Resumen Ejecutivo del Incidente", "requerido": false, "filas": 5}
  ]
}'
WHERE CodigoSeccion = 'SEC_2';

-- Actualizar Secci√≥n 3 - Agregar indicadores de compromiso
UPDATE ANCI_FORMULARIO_CONFIG
SET CamposJSON = '{
  "campos": [
    {"nombre": "tipoAmenaza", "tipo": "select", "etiqueta": "Tipo de Amenaza Probable", "opciones": ["Malware", "Phishing", "DDoS", "Intrusi√≥n", "Fuga de datos", "Insider threat", "Otro"], "requerido": true},
    {"nombre": "origenAtaque", "tipo": "select", "etiqueta": "Origen/Vector de Ataque Probable", "opciones": ["Interno", "Externo", "Mixto", "Desconocido"], "requerido": true},
    {"nombre": "responsableCliente", "tipo": "text", "etiqueta": "Responsable del Cliente", "requerido": false},
    {"nombre": "iocIPs", "tipo": "textarea", "etiqueta": "Indicadores de Compromiso - IPs", "requerido": false, "filas": 3, "placeholder": "Direcciones IP sospechosas (una por l√≠nea)"},
    {"nombre": "iocDominios", "tipo": "textarea", "etiqueta": "Indicadores de Compromiso - Dominios", "requerido": false, "filas": 3, "placeholder": "Dominios maliciosos (uno por l√≠nea)"},
    {"nombre": "iocHashes", "tipo": "textarea", "etiqueta": "Indicadores de Compromiso - Hashes", "requerido": false, "filas": 3, "placeholder": "Hashes de archivos maliciosos (uno por l√≠nea)"}
  ]
}'
WHERE CodigoSeccion = 'SEC_3';

-- Actualizar Secci√≥n 5 - Agregar campos de contenci√≥n detallada
UPDATE ANCI_FORMULARIO_CONFIG
SET CamposJSON = '{
  "campos": [
    {"nombre": "medidasContencion", "tipo": "textarea", "etiqueta": "Medidas de Contenci√≥n Iniciales", "requerido": true, "filas": 4},
    {"nombre": "accionesContencion", "tipo": "textarea", "etiqueta": "Acciones de Contenci√≥n Espec√≠ficas", "requerido": false, "filas": 4},
    {"nombre": "sistemasDesconectados", "tipo": "textarea", "etiqueta": "Sistemas Desconectados/Aislados", "requerido": false, "filas": 3},
    {"nombre": "notificacionesInternas", "tipo": "textarea", "etiqueta": "Notificaciones Internas Realizadas", "requerido": false, "filas": 3},
    {"nombre": "planAccion", "tipo": "textarea", "etiqueta": "Plan de Acci√≥n Implementado", "requerido": false, "filas": 4}
  ]
}'
WHERE CodigoSeccion = 'SEC_5';

-- Insertar nueva secci√≥n para campos espec√≠ficos OIV
INSERT INTO ANCI_FORMULARIO_CONFIG (
    CodigoSeccion, TipoSeccion, NumeroOrden, TituloSeccion, DescripcionSeccion, 
    AplicaOIV, AplicaPSE, EsObligatorio, CamposJSON, ColorSeccion, IconoSeccion,
    MaxComentarios, MaxArchivos, MaxTamanoMB, Activo
) VALUES (
    'SEC_OIV', 'CONDICIONAL', 100, 'Informaci√≥n Espec√≠fica OIV', 
    'Campos espec√≠ficos para Operadores de Infraestructura Vital',
    1, 0, 0, -- Solo para OIV
    '{
      "campos": [
        {"nombre": "cuentaConSGSI", "tipo": "radio", "etiqueta": "¬øCuenta con Sistema de Gesti√≥n de Seguridad de la Informaci√≥n?", "opciones": ["S√≠", "No"], "requerido": true},
        {"nombre": "detallePlanContinuidad", "tipo": "textarea", "etiqueta": "Detalle del Plan de Continuidad", "requerido": false, "filas": 4},
        {"nombre": "activoPlanRecuperacion", "tipo": "textarea", "etiqueta": "Plan de Recuperaci√≥n Activo", "requerido": false, "filas": 4},
        {"nombre": "auditoriasRealizadas", "tipo": "textarea", "etiqueta": "Auditor√≠as de Seguridad Realizadas", "requerido": false, "filas": 3},
        {"nombre": "fechaUltimaAuditoria", "tipo": "date", "etiqueta": "Fecha de √öltima Auditor√≠a", "requerido": false},
        {"nombre": "delegadoTecnico", "tipo": "text", "etiqueta": "Delegado T√©cnico Responsable", "requerido": false},
        {"nombre": "medidasPropagacion", "tipo": "textarea", "etiqueta": "Medidas contra Propagaci√≥n", "requerido": false, "filas": 3},
        {"nombre": "notificacionAfectados", "tipo": "textarea", "etiqueta": "Notificaci√≥n a Afectados", "requerido": false, "filas": 3},
        {"nombre": "registroCapacitaciones", "tipo": "textarea", "etiqueta": "Registro de Capacitaciones", "requerido": false, "filas": 3}
      ]
    }',
    '#6f42c1', 'building', 6, 10, 10, 1
);

-- Insertar secci√≥n de contacto de seguimiento
INSERT INTO ANCI_FORMULARIO_CONFIG (
    CodigoSeccion, TipoSeccion, NumeroOrden, TituloSeccion, DescripcionSeccion, 
    AplicaOIV, AplicaPSE, EsObligatorio, CamposJSON, ColorSeccion, IconoSeccion,
    MaxComentarios, MaxArchivos, MaxTamanoMB, Activo
) VALUES (
    'SEC_CONTACTO', 'FIJA', 101, 'Contacto de Seguimiento', 
    'Informaci√≥n de contacto para seguimiento del incidente',
    1, 1, 1, -- Para OIV y PSE
    '{
      "campos": [
        {"nombre": "contactoSeguimientoNombre", "tipo": "text", "etiqueta": "Nombre del Contacto de Seguimiento", "requerido": true},
        {"nombre": "contactoSeguimientoHorario", "tipo": "text", "etiqueta": "Horario de Disponibilidad", "requerido": true, "placeholder": "Ej: Lunes a Viernes 9:00-18:00"},
        {"nombre": "contactoSeguimientoCorreo", "tipo": "email", "etiqueta": "Correo del Contacto", "requerido": true},
        {"nombre": "contactoSeguimientoTelefono", "tipo": "tel", "etiqueta": "Tel√©fono del Contacto", "requerido": true},
        {"nombre": "estadoActualIncidente", "tipo": "select", "etiqueta": "Estado Actual del Incidente", "opciones": ["Activo", "Contenido", "En Investigaci√≥n", "Erradicado", "Recuperaci√≥n", "Cerrado"], "requerido": true}
      ]
    }',
    '#20c997', 'phone', 6, 10, 10, 1
);
```

### **2. Actualizar Estructura de Tablas**

```sql
-- Agregar campos faltantes a la tabla Incidentes
ALTER TABLE Incidentes ADD 
    AnciNombreReportante NVARCHAR(500),
    AnciCargoReportante NVARCHAR(500),
    AnciCorreoReportante NVARCHAR(500),
    AnciTelefonoReportante NVARCHAR(100),
    AnciFormacionCertificacion NVARCHAR(MAX),
    AnciFechaAlertaTemprana DATETIME2,
    AnciSistemasAfectadosDetalle NVARCHAR(MAX),
    AnciImpactoContinuidadDatos NVARCHAR(MAX),
    AnciAfectacionTerceros BIT,
    AnciNumeroAfectados INT,
    AnciAccionesContencion NVARCHAR(MAX),
    AnciSistemasDesconectados NVARCHAR(MAX),
    AnciNotificacionesInternas NVARCHAR(MAX),
    AnciEstadoActualIncidente NVARCHAR(200),
    AnciContactoSeguimientoNombre NVARCHAR(500),
    AnciContactoSeguimientoHorario NVARCHAR(200),
    AnciContactoSeguimientoCorreo NVARCHAR(500),
    AnciContactoSeguimientoTelefono NVARCHAR(100),
    AnciOIVCuentaConSGSI BIT,
    AnciOIVDetallePlanContinuidad NVARCHAR(MAX),
    AnciOIVActivoPlanRecuperacion NVARCHAR(MAX),
    AnciOIVAuditoriasRealizadas NVARCHAR(MAX),
    AnciOIVFechaUltimaAuditoria DATE,
    AnciOIVDelegadoTecnico NVARCHAR(500),
    AnciOIVMedidasPropagacion NVARCHAR(MAX),
    AnciOIVNotificacionAfectados NVARCHAR(MAX),
    AnciOIVRegistroCapacitaciones NVARCHAR(MAX);
```

### **3. Crear Procedimiento de Validaci√≥n Completa**

```sql
CREATE OR ALTER PROCEDURE sp_ValidarIncidenteANCI
    @IncidenteID INT
AS
BEGIN
    DECLARE @Resultado TABLE (
        Campo NVARCHAR(100),
        Validacion NVARCHAR(500),
        Estado NVARCHAR(20),
        Mensaje NVARCHAR(1000)
    );

    DECLARE @TipoEmpresa NVARCHAR(10);
    SELECT @TipoEmpresa = e.TipoEmpresa 
    FROM Incidentes i 
    INNER JOIN Empresas e ON i.EmpresaID = e.EmpresaID 
    WHERE i.IncidenteID = @IncidenteID;

    -- Validaciones b√°sicas
    INSERT INTO @Resultado
    SELECT 'Titulo', 'Campo obligatorio', 
           CASE WHEN Titulo IS NOT NULL AND LEN(Titulo) > 0 THEN 'OK' ELSE 'ERROR' END,
           CASE WHEN Titulo IS NOT NULL AND LEN(Titulo) > 0 THEN 'Campo completo' ELSE 'T√≠tulo del incidente es obligatorio' END
    FROM Incidentes WHERE IncidenteID = @IncidenteID;

    -- Validaciones de reportante
    INSERT INTO @Resultado
    SELECT 'AnciNombreReportante', 'Campo obligatorio ANCI', 
           CASE WHEN AnciNombreReportante IS NOT NULL AND LEN(AnciNombreReportante) > 0 THEN 'OK' ELSE 'ERROR' END,
           CASE WHEN AnciNombreReportante IS NOT NULL AND LEN(AnciNombreReportante) > 0 THEN 'Campo completo' ELSE 'Nombre del reportante es obligatorio para ANCI' END
    FROM Incidentes WHERE IncidenteID = @IncidenteID;

    -- Validaciones espec√≠ficas OIV
    IF @TipoEmpresa = 'OIV'
    BEGIN
        INSERT INTO @Resultado
        SELECT 'AnciOIVCuentaConSGSI', 'Campo obligatorio para OIV', 
               CASE WHEN AnciOIVCuentaConSGSI IS NOT NULL THEN 'OK' ELSE 'ERROR' END,
               CASE WHEN AnciOIVCuentaConSGSI IS NOT NULL THEN 'Campo completo' ELSE 'Informaci√≥n sobre SGSI es obligatoria para OIV' END
        FROM Incidentes WHERE IncidenteID = @IncidenteID;
    END;

    -- Validaci√≥n CSIRT para incidentes cr√≠ticos
    IF EXISTS (SELECT 1 FROM Incidentes WHERE IncidenteID = @IncidenteID AND Criticidad = 'Cr√≠tica')
    BEGIN
        INSERT INTO @Resultado
        SELECT 'CSIRT', 'Obligatorio para incidentes cr√≠ticos',
               CASE WHEN dbo.fn_ValidarCSIRTParaCriticos(@IncidenteID) = 1 THEN 'OK' ELSE 'ERROR' END,
               CASE WHEN dbo.fn_ValidarCSIRTParaCriticos(@IncidenteID) = 1 THEN 'Solicitud CSIRT configurada' ELSE 'Incidentes cr√≠ticos requieren solicitud CSIRT' END;
    END;

    SELECT * FROM @Resultado;
END
```

## üìä **RESUMEN DE ESTADO**

### **Campos Implementados: 18/52 (35%)**
### **Campos Faltantes: 34/52 (65%)**

### **Prioridad de Implementaci√≥n:**
1. **ALTA** - Campos de reportante (obligatorios)
2. **ALTA** - Campos de impacto detallado
3. **MEDIA** - Campos espec√≠ficos OIV
4. **MEDIA** - Indicadores de compromiso
5. **BAJA** - Campos de seguimiento y contacto

### **Tiempo Estimado de Implementaci√≥n:**
- **Fase 1 (Cr√≠tica)**: 2-3 d√≠as
- **Fase 2 (Importante)**: 3-4 d√≠as
- **Fase 3 (Complementaria)**: 2-3 d√≠as

**Total estimado: 7-10 d√≠as de desarrollo**

### **Recomendaci√≥n:**
Proceder con la implementaci√≥n por fases, priorizando los campos obligatorios de reportante y los campos de impacto detallado que son fundamentales para cumplir con los requisitos ANCI.